import subprocess
import sys
import os
import re
import main


def checktool(tool):
    process = subprocess.run(['which', tool], capture_output=True, text=True)
    if process.returncode == 0:
        return 0
    else:
        process = subprocess.run(['apt-get', 'install', tool], capture_output=True, text=True)
    print(process.stderr)


def start(i):
    remoteServer = input("Enter target to scan: ")
    print("Performing scan  " + i)
    checktool("uniscan")
    if i == "1":
        print("UNISCAN:File Include, Local File Include and Remote Command Execution vulnerability scanner")
        F = "https://" + remoteServer + "/"
        p1 = subprocess.Popen(['uniscan', '-u', F, '-qd'], stdout=sys.stdout, stderr=sys.stderr)
        output = p1.communicate()[0]
        print("------------**RESULTS**----------------------------")
        print(output)

    elif i == "2":
        check = re.findall(r"\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b", remoteServer)
        if check:
            print("Please enter a url for this scan.")
            url = input("URL: ")
            url1 = url.replace('www.', '')
            print("Gathering base Information against target: ")
            print("_______________________________________________________________________________")
            print("WHOIS Record")
            print("_______________________________________________________________________________")
            process = subprocess.run(['whois', url1], capture_output=True, text=True)
            print(process.stdout)
            print("_______________________________________________________________________________")
            print("Performing Dig")
            print("_______________________________________________________________________________")
            process = subprocess.run(['dig', url1], capture_output=True, text=True)
            print(process.stdout)
            print("_______________________________________________________________________________")
            print("NSLookup")
            print("_______________________________________________________________________________")
            process = subprocess.run(['nslookup', url1], capture_output=True, text=True)
            print(process.stdout)
            print("_______________________________________________________________________________")
            print("Web Application Firewall if any")
            print("_______________________________________________________________________________")
            process = subprocess.run(['wafw00f', url1], capture_output=True, text=True)
            print(process.stdout)
            print("_______________________________________________________________________________")
            print("Running theHarvester check. Default Browser: Google")
            print("_______________________________________________________________________________")
            new = "www." + url1
            process = subprocess.run(['theHarvester', '-l', '50', '-b', 'google', '-d', new], capture_output=True,
                                     text=True)
            print(process.stdout)
            print("_______________________________________________________________________________")
            print("Running Email scan through Dmitry")
            print("_______________________________________________________________________________")
            new = "www." + url1
            process = subprocess.run(['dmitry', '-e', new], capture_output=True, text=True)
            print(process.stdout)
            print("_______________________________________________________________________________")
            print("Detecting whether domain has load balancing")
            print("_______________________________________________________________________________")
            new = "www." + url1
            process = subprocess.run(['lbd', new], capture_output=True, text=True)
            print(process.stdout)

        else:
            url1 = remoteServer.replace('www.', '')
            print("Gathering base Information against target: ")
            print("_______________________________________________________________________________")
            print("WHOIS Record")
            print("_______________________________________________________________________________")
            process = subprocess.run(['whois', url1], capture_output=True, text=True)
            print(process.stdout)
            print("_______________________________________________________________________________")
            print("Performing Dig")
            print("_______________________________________________________________________________")
            process = subprocess.run(['dig', url1], capture_output=True, text=True)
            print(process.stdout)
            print("_______________________________________________________________________________")
            print("NSLookup")
            print("_______________________________________________________________________________")
            process = subprocess.run(['nslookup', url1], capture_output=True, text=True)
            print(process.stdout)
            print("_______________________________________________________________________________")
            print("Web Application Firewall if any")
            print("_______________________________________________________________________________")
            process = subprocess.run(['wafw00f', url1], capture_output=True, text=True)
            print(process.stdout)
            print("_______________________________________________________________________________")
            print("Running theHarvester check. Default Browser: Google")
            print("_______________________________________________________________________________")
            new = "www." + url1
            process = subprocess.run(['theHarvester', '-l', '50', '-b', 'google', '-d', new], capture_output=True,
                                     text=True)
            print(process.stdout)
            print("_______________________________________________________________________________")
            print("Running Email scan through Dmitry")
            print("_______________________________________________________________________________")
            new = "www." + url1
            process = subprocess.run(['dmitry', '-e', new], capture_output=True, text=True)
            print(process.stdout)
            print("_______________________________________________________________________________")
            print("Detecting whether domain has load balancing")
            print("_______________________________________________________________________________")
            new = "www." + url1
            process = subprocess.run(['lbd', new], capture_output=True, text=True)
            print(process.stdout)

    elif i == "3":
        check = re.findall(r"\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b", remoteServer)
        if check:
            print("Please enter a url for this scan.")
            url = input("URL starting with http/s: ")
            q = main.checktool("golismero")
            if q == 1:
                path = "golismero"
                out, err = main.git_clone('https://github.com/golismero/golismero.git')
                os.chdir(path)
                process = subprocess.run(['pip', 'install', '-r', 'requirements.txt'], capture_output=True, text=True)
                OP = input("Would you like To go for a quick scan? y/n: ")
                if OP == "y":
                    p1 = subprocess.Popen(['python', 'golismero.py', '-p', 'quick', url], stdout=sys.stdout,
                                          stderr=sys.stderr)
                    output = p1.communicate()[0]
                    print(output)
                else:
                    p1 = subprocess.Popen(['python', 'golismero.py', 'scan', url], stdout=sys.stdout, stderr=sys.stderr)
                    output = p1.communicate()[0]
                    print(output)
            else:
                print("_______________________________________________________________________________")
                print("Performing Golismero")
                print("_______________________________________________________________________________")
                OP = input("Would you like To go for a quick scan? y/n: ")
                if OP == "y":
                    p1 = subprocess.Popen(['python', 'golismero.py', '-p', 'quick', url], stdout=sys.stdout,
                                          stderr=sys.stderr)
                    output = p1.communicate()[0]
                    print(output)
                else:
                    p1 = subprocess.Popen(['python', 'golismero.py', 'scan', url], stdout=sys.stdout, stderr=sys.stderr)
                    output = p1.communicate()[0]
                    print(output)

        else:
            q2 = main.checktool("golismero")
            if q2 == 1:
                out, err = main.git_clone('https://github.com/golismero/golismero.git')
                path = "golismero"
                os.chdir(path)
                process = subprocess.run(['pip', 'install', '-r', 'requirements.txt'], capture_output=True, text=True)
                print("_______________________________________________________________________________")
                print("Performing Golismero")
                print("_______________________________________________________________________________")
                OP = input("Would you like To go for a quick scan? y/n: ")
                if OP == "y":
                    p1 = subprocess.Popen(['python', 'golismero.py', '-p', 'quick', remoteServer], stdout=sys.stdout,
                                          stderr=sys.stderr)
                    output = p1.communicate()[0]
                    print(output)
                else:
                    p1 = subprocess.Popen(['python', 'golismero.py', 'scan', remoteServer], stdout=sys.stdout,
                                          stderr=sys.stderr)
                    output = p1.communicate()[0]
                    print(output)
            else:
                print("_______________________________________________________________________________")
                print("Performing Golismero")
                print("_______________________________________________________________________________")
                process = subprocess.run(['golismero', 'scan', remoteServer], capture_output=True, text=True)
                print(process.stdout)
    else:
        print("Exit")
